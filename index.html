<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>audioPlayer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./normalize.css">

    <style>
        html, body{height: 100%; background: linear-gradient(to bottom, #005197, #fff) no-repeat;}
        *{box-sizing: border-box;}
        .player1{
            width: 300px;
            height: 300px;
            margin: 0 auto;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateY(-50%);
            top: 50%;
            
        }
        

        .cover-img{
            width: calc(100% - 20px);
            height: calc(100% - 20px);
            border-radius: 50%;
            position: absolute;
            background: red;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        svg{
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="player1" class="player1">
    </div>

    <script>

        const player1 = new Player1({
            width: 300,
            height: 300,
            strokeWidth: 10,
            target: '#player1',
            coverUrl: 'https://www.bookswage.com/files/877cac95f75049c39f03c2f499ff81311686557110717/QxIuQIIcxD.png',
        });


        function Player1 (param){
            const t = this;

            t.width = 0;
            t.height = 0;
            t.radius = 0;
            t.strokeWidth = 0;
            t.target;
            t.playBar;
            t.coverUrl = '';
            t.circumference = 0;
            t.curDeg = 0;

            t.isDowned - false; //마우스 클릭시


            const curOffset = deg => t.circumference * (1 - (deg / 360));
            const radianToDeg  = r => r * 180 / Math.PI;
            const degToRadian  = deg => deg * Math.PI / 180;;

            function constructor(){
                t.width = param.width;
                t.height = param.height;
                t.strokeWidth = param.strokeWidth;
                t.target = document.querySelector(param.target);
                t.coverUrl = param.coverUrl;
                t.radius = (t.width * .5) - t.strokeWidth;

                t.curDeg = 0;

                

                const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                const coverImg = document.createElement('div');

                t.circumference = 2 * Math.PI * ((t.width * .5) - (t.strokeWidth));
                

                const coverPad = (t.strokeWidth * 2) + 5;
                
                coverImg.style.cssText = `
                    background: url(${t.coverUrl}) no-repeat center;
                    width: ${t.width - (coverPad * 2)}px;
                    height: ${t.height - (coverPad * 2)}px;
                    border-radius: 50%;
                    position: absolute;
                    top: ${coverPad}px;
                    left: ${coverPad}px;
                `;

                const playBarTrack = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                const playBar = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                const handler = document.createElementNS("http://www.w3.org/2000/svg", "circle");

                t.playBar = playBar;


                playBarTrack.setAttribute('cx', t.width * .5);
                playBarTrack.setAttribute('cy', t.height * .5);
                playBarTrack.setAttribute('r', t.radius);
                playBarTrack.setAttribute('fill', 'none');
                playBarTrack.setAttribute('stroke', 'rgba(255, 255, 255, .5)');
                playBarTrack.setAttribute('stroke-width', t.strokeWidth);

                playBar.setAttribute('cx', t.width * .5);
                playBar.setAttribute('cy', t.height * .5);
                playBar.setAttribute('r', t.radius);
                playBar.setAttribute('fill', 'none');
                playBar.style.transform = 'rotate(-90deg)';
                playBar.style.transformOrigin = '50%';
                playBar.setAttribute('stroke', '#005197');
                playBar.setAttribute('stroke-width', t.strokeWidth);
                playBar.setAttribute('stroke-linecap', 'round');
                
                playBar.setAttribute('stroke-dasharray', t.circumference);
                playBar.setAttribute('stroke-dashoffset', curOffset(t.curDeg));
                
                
                handler.setAttribute('cx', t.width * .5);
                handler.setAttribute('cy', t.strokeWidth);
                handler.setAttribute('r', t.strokeWidth);
                handler.setAttribute('fill', '#005197');

                t.handler = handler;


                svg.appendChild(playBarTrack);
                svg.appendChild(playBar);
                svg.appendChild(handler);
                
                t.target.appendChild(svg);
                t.target.appendChild(coverImg);

                
                t.target.removeEventListener('mousedown', fnc_mouseDownEvent);
                t.target.removeEventListener('mousemove', fnc_mouseMoveEvent);
                t.target.removeEventListener('mouseup', fnc_mouseUpEvent);
                t.target.removeEventListener('touchstart', fnc_mouseDownEvent);
                t.target.removeEventListener('touchmove', fnc_mouseMoveEvent);
                t.target.removeEventListener('touchend', fnc_mouseUpEvent);
                
                t.target.addEventListener('mousedown', fnc_mouseDownEvent);
                t.target.addEventListener('mousemove', fnc_mouseMoveEvent);
                t.target.addEventListener('mouseup', fnc_mouseUpEvent);
                t.target.addEventListener('touchstart', fnc_mouseDownEvent);
                t.target.addEventListener('touchmove', fnc_mouseMoveEvent);
                t.target.addEventListener('touchend', fnc_mouseUpEvent);

                

                function fnc_mouseDownEvent(e){
                    // e.preventDefault();
                    t.isDowned = true;

                }
                function fnc_mouseMoveEvent(e){
                    e.preventDefault();
                    if(!t.isDowned) return;

                    const xy = t.target.getBoundingClientRect();

                    const x = e.touches ? e.touches[0].clientX - xy.x : e.offsetX;
                    const y = e.touches ? e.touches[0].clientY - xy.y: e.offsetY;

                    t.playing2(getDxy(x, y));
                }
                function fnc_mouseUpEvent(e){
                    e.preventDefault();
                    if(!t.isDowned) return;

                    const xy = t.target.getBoundingClientRect();

                    const x = e.changedTouches ? e.changedTouches[0].clientX - xy.x : e.offsetX;
                    const y = e.changedTouches ? e.changedTouches[0].clientY - xy.y : e.offsetY;

                    t.playing(getDxy(x, y));
                    t.isDowned = false;
                }



                function fnc_handler(e){
                    const x = e.offsetX;
                    const y = e.offsetY;
                    console.log(e);
                }

                function getDxy(x, y){
                    const centerX = t.width * .5;
                    const centerY = t.height * .5;

                    const dx = centerX - x;
                    const dy = centerY - y;
                    const dxy = Math.sqrt(dx * dx + dy * dy);

                    let curDeg = 0;

                    if(x > centerX && y < centerY){ //1사분면
                        curDeg = radianToDeg(Math.acos(dy / dxy));
                    }else if(x > centerX && y > centerY){   //4사분면
                        curDeg = 90 - radianToDeg(Math.acos(dx/ dxy)) + 180;
                    }else if(x < centerX && y < centerY){   //2사분면
                        curDeg = radianToDeg(Math.acos(dx/ dxy)) + 270;
                    }else if(x < centerX && y > centerY){   //3사분면
                        curDeg = 90 - radianToDeg(Math.acos(dy / dxy)) + 270;
                    }else{
                        if(x > centerX) curDeg = 90;
                        else if(x < centerX) curDeg = 270;
                        else if(y > centerY) curDeg = 180;
                        else if(y < centerY) curDeg = 0;
                    }

                    // console.log(curDeg);
                    return curDeg;
                }

                function fnc_handler2(e){
                    const x = e.offsetX;
                    const y = e.offsetY;

                    const centerX = t.width * .5;
                    const centerY = t.height * .5;

                    const dx = centerX - x;
                    const dy = centerY - y;
                    const dxy = Math.sqrt(dx * dx + dy * dy);

                    let clickedDeg = 0;

                    if(x > centerX && y < centerY){ //1사분면
                        clickedDeg = radianToDeg(Math.acos(dy / dxy));
                    }else if(x > centerX && y > centerY){   //4사분면
                        clickedDeg = 90 - radianToDeg(Math.acos(dx/ dxy)) + 180;
                    }else if(x < centerX && y < centerY){   //2사분면
                        clickedDeg = radianToDeg(Math.acos(dx/ dxy)) + 270;
                    }else if(x < centerX && y > centerY){   //3사분면
                        clickedDeg = 90 - radianToDeg(Math.acos(dy / dxy)) + 270;
                    }else{
                        if(x > centerX) clickedDeg = 90;
                        else if(x < centerX) clickedDeg = 270;
                        else if(y > centerY) clickedDeg = 180;
                        else if(y < centerY) clickedDeg = 0;
                    }

                    t.curDeg = clickedDeg;

                    console.log(t.curDeg);

                    t.playing(t.curDeg);
                }

            }

            constructor();

            t.playing = (deg) => {
                t.curDeg = deg;
                t.playBar.setAttribute('stroke-dasharray', t.circumference);
                t.playBar.setAttribute('stroke-dashoffset', curOffset(deg));

                t.handler.setAttribute('cx', Math.sin(degToRadian(deg)) * t.radius + (t.width * .5));
                t.handler.setAttribute('cy', t.height - (Math.cos(degToRadian(deg)) * t.radius + (t.height * .5)));
            }
            
            t.playing2 = (deg) => {
                t.curDeg = deg;
                t.handler.setAttribute('cx', Math.sin(degToRadian(deg)) * t.radius + (t.width * .5));
                t.handler.setAttribute('cy', t.height - (Math.cos(degToRadian(deg)) * t.radius + (t.height * .5)));
            } 
        }





    </script>
</body>
</html>